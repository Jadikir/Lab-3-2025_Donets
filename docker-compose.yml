version: "3.6"
services:

  apiserver:
    command:
    - apiserver
    container_name: clearml-apiserver
    image: allegroai/clearml:latest
    restart: unless-stopped
    volumes:
    - /opt/clearml/logs:/var/log/clearml
    - /opt/clearml/config:/opt/clearml/config
    - /opt/clearml/data/fileserver:/mnt/fileserver
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # УВЕЛИЧЬТЕ ДО 120s
    environment:
      CLEARML_ELASTIC_SERVICE_HOST: elasticsearch
      CLEARML_ELASTIC_SERVICE_PORT: 9200
      CLEARML_ELASTIC_SERVICE_PASSWORD: ${ELASTIC_PASSWORD}
      CLEARML_MONGODB_SERVICE_HOST: mongo
      CLEARML_MONGODB_SERVICE_PORT: 27017
      CLEARML_REDIS_SERVICE_HOST: redis
      CLEARML_REDIS_SERVICE_PORT: 6379
      CLEARML_SERVER_DEPLOYMENT_TYPE: ${CLEARML_SERVER_DEPLOYMENT_TYPE:-linux}
      CLEARML__apiserver__pre_populate__enabled: "true"
      CLEARML__apiserver__pre_populate__zip_files: "/opt/clearml/db-pre-populate"
      CLEARML__apiserver__pre_populate__artifacts_path: "/mnt/fileserver"
      CLEARML__apiserver__pre_populate__demo_user: "true"
      CLEARML__apiserver__pre_populate__demo_user_password: "password123"
    ports:
    - "8008:8008"
    networks:
      - backend
      - frontend

  elasticsearch:
    networks:
      - backend
    container_name: clearml-elastic
    environment:
      ES_JAVA_OPTS: -Xms2g -Xmx2g
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      discovery.type: single-node
      xpack.security.enabled: false
      xpack.security.http.ssl.enabled: false
      xpack.security.transport.ssl.enabled: false
      xpack.security.enrollment.enabled: false
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    restart: unless-stopped
    volumes:
      - elastic_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  fileserver:
    networks:
      - backend
      - frontend
    command:
    - fileserver
    container_name: clearml-fileserver
    image: allegroai/clearml:latest
    restart: unless-stopped
    volumes:
    - /opt/clearml/logs:/var/log/clearml
    - /opt/clearml/data/fileserver:/mnt/fileserver
    - /opt/clearml/config:/opt/clearml/config
    depends_on:
      apiserver:
        condition: service_started  # ИЗМЕНИТЕ НА service_started
    ports:
    - "8081:8081"

  mongo:
    networks:
      - backend
    container_name: clearml-mongo
    image: mongo:6.0
    restart: unless-stopped
    volumes:
    - /opt/clearml/data/mongo2/db:/data/db
    - /opt/clearml/data/mongo2/configdb:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  redis:
    networks:
      - backend
    container_name: clearml-redis
    image: redis:8.4.0
    restart: unless-stopped
    command: redis-server --save "" --appendonly no
    volumes:
    - /opt/clearml/data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  webserver:
    command:
    - webserver
    container_name: clearml-webserver
    image: allegroai/clearml:latest
    restart: unless-stopped
    depends_on:
      apiserver:
        condition: service_started  # ИЗМЕНИТЕ НА service_started
    ports:
    - "8080:80"
    networks:
      - backend
      - frontend

  # # agent-services:
  #   networks:
  #     - backend
  #   container_name: clearml-agent-services
  #   image: allegroai/clearml-agent:latest
  #   deploy:
  #     restart_policy:
  #       condition: on-failure
  #   privileged: true
  #   environment:
  #     CLEARML_HOST_IP: ${CLEARML_HOST_IP}
  #     CLEARML_WEB_HOST: ${CLEARML_WEB_HOST:-}
  #     CLEARML_API_HOST: http://apiserver:8008
  #     CLEARML_FILES_HOST: ${CLEARML_FILES_HOST:-}
  #     CLEARML_API_ACCESS_KEY: ${CLEARML_API_ACCESS_KEY:-}
  #     CLEARML_API_SECRET_KEY: ${CLEARML_API_SECRET_KEY:-}
  #     CLEARML_AGENT_GIT_USER: ${CLEARML_AGENT_GIT_USER}
  #     CLEARML_AGENT_GIT_PASS: ${CLEARML_AGENT_GIT_PASS}
  #     CLEARML_AGENT_UPDATE_VERSION: ">=0.17.0"
  #     CLEARML_AGENT_DEFAULT_BASE_DOCKER: "ubuntu:18.04"
  #     AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
  #     AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
  #     AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-}
  #     AZURE_STORAGE_ACCOUNT: ${AZURE_STORAGE_ACCOUNT:-}
  #     AZURE_STORAGE_KEY: ${AZURE_STORAGE_KEY:-}
  #     GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-}
  #     CLEARML_WORKER_ID: "clearml-services"
  #     CLEARML_AGENT_DOCKER_HOST_MOUNT: "/opt/clearml/agent:/root/.clearml"
  #     SHUTDOWN_IF_NO_ACCESS_KEY: 1
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - /opt/clearml/agent:/root/.clearml
  #   depends_on:
  #     apiserver:
  #       condition: service_started  # ИЗМЕНИТЕ НА service_started

networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge

volumes:
  elastic_data: